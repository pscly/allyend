{% extends "base.html" %}
{% block content %}
  <section class="page-header">
    <h2>文件空间</h2>
    <p>在这里管理团队文件，支持分组共享与 API 令牌自动同步。</p>
  </section>

  {% if user %}
  <section class="card">
    <div class="card-header">
      <h3>上传到我的空间</h3>
      <span class="hint">选择可见性：仅自己 / 分组 / 公开。</span>
    </div>
    <form id="user-upload" class="form-grid">
      <label for="user-file">选择文件</label>
      <input id="user-file" name="file" type="file" required />
      <label for="user-name">显示名称</label>
      <input id="user-name" name="file_name" type="text" placeholder="示例：日报.xlsx" />
      <label for="user-visibility">可见性</label>
      <select id="user-visibility" name="visibility">
        <option value="private">仅自己</option>
        <option value="group">分组内</option>
        <option value="public">公开</option>
      </select>
      <label for="user-desc">备注说明</label>
      <textarea id="user-desc" name="description" rows="2" placeholder="文件用途说明"></textarea>
      <button type="submit">上传</button>
      <div class="hint" id="user-hint"></div>
    </form>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>我的文件</h3>
      <div class="table-actions">
        <select id="file-scope">
          <option value="private">仅自己</option>
          <option value="group">分组内</option>
          <option value="public">公开</option>
        </select>
        <button type="button" id="refresh-files">刷新</button>
      </div>
    </div>
    <div class="table-scroll">
      <table class="data-table" id="my-files-table">
        <thead><tr><th>名称</th><th>可见性</th><th>大小</th><th>上传时间</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>API 令牌</h3>
      <div class="table-actions">
        <button type="button" id="refresh-tokens">刷新</button>
      </div>
    </div>
    <form id="token-create" class="form-grid">
      <label for="token-name">令牌名称</label>
      <input id="token-name" name="name" type="text" placeholder="例如：CI 同步" />
      <label for="token-ips">允许 IP（逗号分隔）</label>
      <input id="token-ips" name="allowed_ips" type="text" />
      <label for="token-cidrs">允许网段（逗号分隔）</label>
      <input id="token-cidrs" name="allowed_cidrs" type="text" />
      <button type="submit">创建令牌</button>
      <div class="hint" id="token-hint"></div>
    </form>
    <div class="table-scroll">
      <table class="data-table" id="token-table">
        <thead><tr><th>令牌</th><th>名称</th><th>限制</th><th>状态</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="hint">上传：<code>POST /files/&lt;token&gt;/up</code>，列出：<code>GET /files/&lt;token&gt;</code></p>
  </section>
  {% else %}
  <section class="card">
    <div class="card-header">
      <h3>需要登录</h3>
    </div>
    <p class="hint">请登录后上传或管理文件，未登录仍可浏览公开文件列表。</p>
  </section>
  {% endif %}

  <section class="card">
    <div class="card-header">
      <h3>公开文件</h3>
      <div class="table-actions">
        <button type="button" id="refresh-public">刷新</button>
      </div>
    </div>
    <div class="table-scroll">
      <table class="data-table" id="public-files-table">
        <thead><tr><th>名称</th><th>大小</th><th>上传时间</th><th>下载</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const userPresent = {{ 'true' if user else 'false' }};

  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.detail || `请求失败(${res.status})`);
    }
    return res.json();
  }

  const formatSize = (bytes) => {
    if (bytes === null || bytes === undefined) return '-';
    if (bytes < 1024) return `${bytes} B`;
    const units = ['KB', 'MB', 'GB', 'TB'];
    let size = bytes / 1024;
    let unitIndex = 0;
    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex++;
    }
    return `${size.toFixed(1)} ${units[unitIndex]}`;
  };

  async function loadPublicFiles() {
    try {
      const data = await fetchJSON('/files/public?limit=100');
      const tbody = document.querySelector('#public-files-table tbody');
      tbody.innerHTML = data.map(file => {
        const link = `/files/${file.id}/download`;
        return `<tr><td>${file.original_name}</td><td>${formatSize(file.size_bytes)}</td><td>${new Date(file.created_at).toLocaleString()}</td><td><a href="${link}" target="_blank">下载</a></td></tr>`;
      }).join('');
    } catch (error) {
      console.error(error);
    }
  }

  if (userPresent) {
    const uploadForm = document.getElementById('user-upload');
    const uploadHint = document.getElementById('user-hint');
    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(uploadForm);
      try {
        await fetchJSON('/files/me/up', { method: 'POST', body: formData });
        uploadHint.textContent = '上传成功';
        uploadHint.style.color = 'var(--color-primary)';
        uploadForm.reset();
        loadMyFiles();
        loadPublicFiles();
      } catch (error) {
        uploadHint.textContent = error.message;
        uploadHint.style.color = '#b91c1c';
      }
    });

    async function loadMyFiles() {
      const scope = document.getElementById('file-scope').value;
      try {
        const data = await fetchJSON(`/files/me?scope=${scope}`);
        const tbody = document.querySelector('#my-files-table tbody');
        tbody.innerHTML = data.map(file => {
          const link = `/files/${file.id}/download`;
          return `<tr><td>${file.original_name}</td><td>${file.visibility}</td><td>${formatSize(file.size_bytes)}</td><td>${new Date(file.created_at).toLocaleString()}</td><td><a href="${link}" target="_blank">下载</a> <button class="text" data-file="${file.id}">删除</button></td></tr>`;
        }).join('');
        tbody.querySelectorAll('button[data-file]').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('确认删除该文件？')) return;
            await fetchJSON(`/files/me/${btn.dataset.file}`, { method: 'DELETE' });
            loadMyFiles();
            loadPublicFiles();
          });
        });
      } catch (error) {
        console.error(error);
      }
    }

    async function loadTokens() {
      try {
        const data = await fetchJSON('/files/api/tokens');
        const tbody = document.querySelector('#token-table tbody');
        tbody.innerHTML = data.map(token => {
          const limit = [token.allowed_ips, token.allowed_cidrs].filter(Boolean).join(' / ') || '-';
          const state = token.is_active ? '启用' : '禁用';
          return `<tr><td><code>${token.token}</code></td><td>${token.name || '-'}</td><td>${limit}</td><td>${state}</td><td><button class="text" data-token="${token.id}" data-active="${token.is_active ? '1' : '0'}">${token.is_active ? '禁用' : '启用'}</button></td></tr>`;
        }).join('');
        tbody.querySelectorAll('button[data-token]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const formData = new FormData();
            formData.append('is_active', btn.dataset.active === '0');
            await fetchJSON(`/files/api/tokens/${btn.dataset.token}`, { method: 'PATCH', body: formData });
            loadTokens();
          });
        });
      } catch (error) {
        console.error(error);
      }
    }

    document.getElementById('refresh-files').addEventListener('click', loadMyFiles);
    document.getElementById('file-scope').addEventListener('change', loadMyFiles);
    document.getElementById('refresh-tokens').addEventListener('click', loadTokens);
    const tokenForm = document.getElementById('token-create');
    tokenForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = Object.fromEntries(new FormData(tokenForm).entries());
      const hint = document.getElementById('token-hint');
      try {
        const res = await fetchJSON('/files/api/tokens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        hint.textContent = `令牌创建成功：${res.token}`;
        hint.style.color = 'var(--color-primary)';
        tokenForm.reset();
        loadTokens();
      } catch (error) {
        hint.textContent = error.message;
        hint.style.color = '#b91c1c';
      }
    });

    loadMyFiles();
    loadTokens();
  }

  document.getElementById('refresh-public').addEventListener('click', loadPublicFiles);
  loadPublicFiles();
})();
</script>
{% endblock %}
