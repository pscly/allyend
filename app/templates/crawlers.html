{% extends "base.html" %}
{% block content %}
  <section class="page-header">
    <h2>爬虫监控中心</h2>
    <p>通过统一的 /pa 接入上报运行状态，支持快捷匿名链接与日志筛选。</p>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>API Key 管理</h3>
      <div class="table-actions">
        <button onclick="createKey()">生成新 Key</button>
      </div>
    </div>
    <div class="table-scroll">
      <table class="data-table" id="keys-table">
        <thead><tr><th>ID（本账号）</th><th>Key</th><th>名称</th><th>状态</th><th>最近使用</th><th>公开</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="hint">接口路径已迁移至 <code>/pa/api</code>，请在 SDK 中更新基础地址。</p>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>爬虫列表</h3>
    </div>
    <div class="table-scroll">
      <table class="data-table" id="crawlers-table">
        <thead><tr><th>ID（本账号）</th><th>名称</th><th>最近心跳</th><th>来源 IP</th><th>公开</th><th>快捷链接</th><th>日志用量</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>隐藏的爬虫</h3>
      <div class="table-actions">
        <span class="hint">仅在此处显示已隐藏的工程</span>
      </div>
    </div>
    <div class="table-scroll">
      <table class="data-table" id="hidden-crawlers-table">
        <thead><tr><th>ID（本账号）</th><th>名称</th><th>最近心跳</th><th>来源 IP</th><th>公开</th><th>快捷链接</th><th>日志用量</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>快捷访问链接</h3>
      <div class="table-actions">
        <button type="button" onclick="refreshLinks()">刷新</button>
      </div>
    </div>
    <form id="link-form" class="form-grid">
      <label for="link-target-type">目标类型</label>
      <select id="link-target-type" name="target_type">
        <option value="crawler">爬虫</option>
        <option value="api_key">API Key</option>
        <option value="group">分组</option>
      </select>
      <label for="link-target-id">目标 ID（本账号序号）</label>
      <input id="link-target-id" name="target_id" type="number" required />
      <label for="link-slug">自定义路径（可选）</label>
      <input id="link-slug" name="slug" type="text" placeholder="至少 6 位，例如 mybot01" />
      <label>
        <input type="checkbox" id="link-logs" name="allow_logs" checked /> 允许访问日志
      </label>
      <label for="link-desc">备注说明</label>
      <input id="link-desc" name="description" type="text" placeholder="例如：合作方查看" />
      <button type="submit">生成快捷链接</button>
      <div class="hint" id="link-hint"></div>
    </form>
    <div class="table-scroll">
      <table class="data-table" id="links-table">
        <thead><tr><th>Slug</th><th>类型</th><th>目标</th><th>日志</th><th>创建时间</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="hint">访问地址示例：<code>{{ request.url.scheme }}://{{ request.url.netloc }}/pa/&lt;slug&gt;</code></p>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>日志筛选</h3>
      <div class="table-actions">
        <button class="text" type="button" onclick="resetFilters()">重置</button>
        <button type="button" onclick="loadLogs()">查询</button>
        <button class="text" type="button" onclick="toggleLogFullscreen()">放大</button>
        <button class="text" type="button" onclick="gotoLogDetail()">详情</button>
      </div>
    </div>
    <div class="filters">
      <div>
        <label for="log-crawlers">选择爬虫</label>
        <select id="log-crawlers" multiple></select>
      </div>
      <div>
        <label for="log-start">开始日期</label>
        <input type="date" id="log-start" />
      </div>
      <div>
        <label for="log-end">结束日期</label>
        <input type="date" id="log-end" />
      </div>
      <div>
        <label for="log-min-level">最小等级</label>
        <select id="log-min-level"></select>
      </div>
      <div>
        <label for="log-max-level">最大等级</label>
        <select id="log-max-level"></select>
      </div>
      <div>
        <label for="log-limit">最多条数</label>
        <input type="number" id="log-limit" min="1" max="500" value="200" />
      </div>
      <div>
        <label for="log-device">设备名包含</label>
        <input type="text" id="log-device" placeholder="如：DESKTOP- 或 server-01" />
      </div>
      <div>
        <label for="log-ip">来源 IP 包含</label>
        <input type="text" id="log-ip" placeholder="如：10.0. 或 192.168." />
      </div>
      <div>
        <label for="log-query">关键字/正则</label>
        <input type="text" id="log-query" placeholder="例如：/招标计划/ 或 采集" />
        <label class="inline" style="margin-left:8px;">
          <input type="checkbox" id="log-regex-mode" /> 正则匹配
        </label>
      </div>
    </div>
    <div class="log-list" id="log-list"></div>
    <div class="empty-hint" id="log-empty" style="display:none;">暂无日志，可调整筛选后再次查询。</div>
  </section>

  <section class="card" id="detail" style="display:none;">
    <div class="card-header">
      <h3 id="detail-title">爬虫详情</h3>
    </div>
    <div class="grid">
      <div>
        <h4>最近运行</h4>
        <div class="table-scroll">
          <table class="data-table">
            <thead><tr><th>ID</th><th>状态</th><th>开始</th><th>结束</th><th>来源 IP</th></tr></thead>
            <tbody id="runs-body"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h4>最近日志</h4>
        <div class="log-list" id="logs-list"></div>
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <div class="card-header">
        <h3>日志用量与上限</h3>
        <div class="table-actions">
          <button type="button" id="usage-refresh">刷新</button>
          <button type="button" id="usage-save">保存上限</button>
          <button type="button" id="usage-clear" class="text" style="color:#b91c1c;">清空日志</button>
        </div>
      </div>
      <div class="form-grid" id="usage-panel">
        <div class="hint">上限为 0 或负数表示不限制；留空表示保持不变（使用默认）。</div>
        <label>当前行数</label>
        <input id="usage-lines" type="text" readonly />
        <label>当前字节</label>
        <input id="usage-bytes" type="text" readonly />
        <label>上限 - 行数</label>
        <input id="limit-lines" type="number" placeholder="默认 1000000（<=0 不限）" />
        <label>上限 - 字节</label>
        <input id="limit-bytes" type="number" placeholder="默认 104857600（<=0 不限）" />
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <div class="card-header">
        <h3>近期统计</h3>
        <div class="table-actions">
          <button class="text" type="button" id="dstats-export-csv">导出 CSV</button>
          <button class="text" type="button" id="dstats-export-png">导出 PNG</button>
          <button type="button" id="dstats-refresh">刷新</button>
        </div>
      </div>
      <div class="filters" style="margin-bottom:0;align-items:flex-end;grid-template-columns: 140px 140px 160px 160px 1fr;">
        <div>
          <label for="dstats-hours">窗口（小时）</label>
          <input type="number" id="dstats-hours" min="1" max="168" value="24" />
        </div>
        <div>
          <label for="dstats-buckets">分桶数量</label>
          <input type="number" id="dstats-buckets" min="2" max="240" value="24" />
        </div>
        <div>
          <label for="dstats-min">最小等级</label>
          <select id="dstats-min"></select>
        </div>
        <div>
          <label for="dstats-max">最大等级</label>
          <select id="dstats-max"></select>
        </div>
        <div>
          <label for="dstats-query">关键字/正则</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="text" id="dstats-query" placeholder="例如：/失败/ 或 error" />
            <label class="inline"><input type="checkbox" id="dstats-regex" /> 正则</label>
            <label class="inline">粒度
              <select id="dstats-granularity">
                <option value="auto" selected>自动</option>
                <option value="day">按天</option>
                <option value="week">按周</option>
              </select>
            </label>
          </div>
        </div>
      </div>
      <div id="dstats-chart" style="margin:12px 8px 4px 8px;display:flex;gap:4px;align-items:flex-end;height:140px;">
        <div class="empty-hint" id="dstats-empty">暂无数据</div>
      </div>
      <div class="hint" id="dstats-meta" style="margin:0 8px 8px 8px;">&nbsp;</div>
      <canvas id="dstats-canvas" width="800" height="240" style="display:none;"></canvas>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  // 初始详情 ID（通过后端注入）；无则为 null
  window.INIT_CRAWLER_ID = {{ initial_crawler_id if initial_crawler_id is not none else 'null' }};
(() => {
  const levelOptions = (window.LOG_LEVEL_OPTIONS || []).slice().sort((a, b) => a.code - b.code);
  const minSelect = document.getElementById('log-min-level');
  const maxSelect = document.getElementById('log-max-level');
  const crawlersSelect = document.getElementById('log-crawlers');

  function renderLevelOptions(select, selected) {
    select.innerHTML = levelOptions.map(opt => `<option value="${opt.code}" ${Number(selected) === Number(opt.code) ? 'selected' : ''}>${opt.code} - ${opt.name}</option>`).join('');
  }
  renderLevelOptions(minSelect, 0);
  renderLevelOptions(maxSelect, 50);

  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.detail || `请求失败(${res.status})`);
    }
    return res.json();
  }

  window.createKey = async () => {
    try {
      await fetchJSON('/api/keys', { method: 'POST' });
      loadKeys();
    } catch (error) {
      alert(error.message);
    }
  }

  async function loadKeys() {
    const data = await fetchJSON('/api/keys');
    const tbody = document.querySelector('#keys-table tbody');
    tbody.innerHTML = data.map(key => {
      const last = key.last_used_at ? new Date(key.last_used_at).toLocaleString() : '-';
      const status = key.active ? '启用' : '禁用';
      const publicFlag = key.is_public ? '是' : '否';
      const name = key.name || '-';
      return `<tr>
        <td title="全局 ID: ${key.id}">${key.local_id}</td>
        <td><code>${key.key}</code></td>
        <td>${name}</td>
        <td>${status}</td>
        <td>${last}</td>
        <td>${publicFlag}</td>
        <td>
          <button class="text" onclick="toggleKey(${key.id}, ${key.active ? 'false' : 'true'})">${key.active ? '禁用' : '启用'}</button>
          <button class="text" onclick="deleteKey(${key.id})">删除</button>
        </td>
      </tr>`;
    }).join('');
  }

  window.toggleKey = async (id, next) => {
    const normalized = typeof next === 'boolean' ? next : String(next).toLowerCase() === 'true';
    const payload = { active: normalized };
    try {
      await fetchJSON(`/api/keys/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      loadKeys();
    } catch (error) {
      alert(error.message);
    }
  };

  window.deleteKey = async (id) => {
    if (!confirm('确认删除此 Key?')) return;
    try {
      await fetchJSON(`/api/keys/${id}`, { method: 'DELETE' });
      loadKeys();
    } catch (error) {
      alert(error.message);
    }
  };

  async function loadCrawlers() {
    const data = await fetchJSON('/pa/api/me');
    const visible = data.filter(c => !c.is_hidden);
    const hidden = data.filter(c => c.is_hidden);

    // 仅将“未隐藏”的工程放入筛选器
    crawlersSelect.innerHTML = visible.map(crawler => {
      const localId = crawler.local_id;
      const displayName = crawler.name || '未命名爬虫';
      return `<option value="${crawler.id}" selected>[#${localId}] ${displayName}</option>`;
    }).join('');

    // 主列表（未隐藏）
    const tbody = document.querySelector('#crawlers-table tbody');
    tbody.innerHTML = visible.map(crawler => {
      const hb = crawler.last_heartbeat ? new Date(crawler.last_heartbeat).toLocaleString() : '-';
      const slug = crawler.public_slug ? `<code>${crawler.public_slug}</code>` : '-';
      const ip = crawler.last_source_ip || '-';
      const localId = crawler.local_id;
      const displayName = crawler.name || '未命名爬虫';
      const safeName = displayName.replace(/'/g, "");
      return `<tr>
        <td title="全局 ID: ${crawler.id}">${localId}</td>
        <td>${displayName}</td>
        <td>${hb}</td>
        <td>${ip}</td>
        <td>${crawler.is_public ? '是' : '否'}</td>
        <td>${slug}</td>
        <td><div class="usage" data-cid="${crawler.id}"><span class="hint">载入中...</span></div></td>
        <td>
          <button class="text" onclick="showDetail(${crawler.id}, '${safeName}')">详情</button>
          <button class="text" style="margin-left:8px;" onclick="hideCrawler(${crawler.id})">隐藏</button>
          <button class="text" style="color:#b91c1c; margin-left:8px;" onclick="quickClearLogs(${crawler.id})">清空日志</button>
          <button class="text" style="color:#7f1d1d; margin-left:8px;" onclick="deleteCrawler(${crawler.id})">删除</button>
        </td>
        </tr>`;
    }).join('');

    // 隐藏列表
    const hbody = document.querySelector('#hidden-crawlers-table tbody');
    hbody.innerHTML = hidden.map(crawler => {
      const hb = crawler.last_heartbeat ? new Date(crawler.last_heartbeat).toLocaleString() : '-';
      const slug = crawler.public_slug ? `<code>${crawler.public_slug}</code>` : '-';
      const ip = crawler.last_source_ip || '-';
      const localId = crawler.local_id;
      const displayName = crawler.name || '未命名爬虫';
      const safeName = displayName.replace(/'/g, "");
      return `<tr>
        <td title="全局 ID: ${crawler.id}">${localId}</td>
        <td>${displayName}</td>
        <td>${hb}</td>
        <td>${ip}</td>
        <td>${crawler.is_public ? '是' : '否'}</td>
        <td>${slug}</td>
        <td><div class="usage" data-cid="${crawler.id}"><span class="hint">载入中...</span></div></td>
        <td>
          <button class="text" onclick="showDetail(${crawler.id}, '${safeName}')">详情</button>
          <button class="text" style="margin-left:8px;" onclick="unhideCrawler(${crawler.id})">取消隐藏</button>
          <button class="text" style="color:#7f1d1d; margin-left:8px;" onclick="deleteCrawler(${crawler.id})">删除</button>
        </td>
        </tr>`;
    }).join('');

    // 渲染每个爬虫的日志用量（异步逐个拉取）
    loadCrawlersUsage();
  }

  function renderUsage(container, usage) {
    const used = Number(usage?.bytes || 0);
    const max = (usage && typeof usage.max_bytes === 'number') ? usage.max_bytes : null;
    if (!max || max <= 0) {
      container.innerHTML = `<span class="hint">${formatBytes(used)}</span>`;
      return;
    }
    const ratio = Math.max(0, Math.min(1, used / max));
    const percent = (ratio * 100).toFixed(1);
    container.innerHTML = `
      <div class="progress" title="${formatBytes(used)} / ${formatBytes(max)}" style="width:160px;height:8px;background:var(--color-border);border-radius:4px;overflow:hidden;">
        <div class="bar" style="height:100%;width:${percent}%;background:var(--color-primary);"></div>
      </div>
      <div class="hint" style="margin-top:4px;">${formatBytes(used)} / ${formatBytes(max)}</div>
    `;
  }

  async function loadCrawlersUsage() {
    const cells = document.querySelectorAll('#crawlers-table .usage[data-cid], #hidden-crawlers-table .usage[data-cid]');
    cells.forEach(async (el) => {
      const cid = el.getAttribute('data-cid');
      try {
        const data = await fetchJSON(`/pa/api/me/${cid}/logs/usage`);
        renderUsage(el, data);
      } catch (e) {
        el.innerHTML = '<span class="hint">-</span>';
      }
    });
  }

  window.quickClearLogs = async (id) => {
    if (!confirm('确认清空该项目的所有日志？此操作不可恢复。')) return;
    try {
      await fetchJSON(`/pa/api/me/${id}/logs`, { method: 'DELETE' });
      loadCrawlersUsage();
      if (window.__currentCrawlerId === id) {
        try { await loadUsage(); } catch (_) {}
      }
      alert('日志已清空');
    } catch (error) {
      alert(error.message);
    }
  };

  window.showDetail = async (id, name) => {
    document.getElementById('detail').style.display = '';
    document.getElementById('detail-title').textContent = `#${id} - ${name}`;
    window.__currentCrawlerId = id;
    const runs = await fetchJSON(`/pa/api/me/${id}/runs`);
    const logs = await fetchJSON(`/pa/api/me/${id}/logs?limit=50`);
    const runsBody = document.getElementById('runs-body');
    runsBody.innerHTML = runs.map(run => `<tr><td>${run.id}</td><td>${run.status}</td><td>${new Date(run.started_at).toLocaleString()}</td><td>${run.ended_at ? new Date(run.ended_at).toLocaleString() : '-'}</td><td>${run.source_ip || '-'}</td></tr>`).join('');
    const levelMap = Object.fromEntries(levelOptions.map(item => [item.code, item.name]));
    const logsList = document.getElementById('logs-list');
    logsList.innerHTML = logs.map(item => {
      const level = levelMap[item.level_code] || item.level;
      return `<div class="log-item"><div class="log-head"><span>${new Date(item.ts).toLocaleString()}</span><span class="badge level-${item.level_code}">${level}</span></div><div>${item.message}</div></div>`;
    }).join('');
    await loadUsage();
  };

  function formatBytes(n) {
    const num = Number(n || 0);
    if (!isFinite(num)) return String(n);
    const units = ['B','KB','MB','GB','TB'];
    let v = num, i = 0;
    while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
    return `${v.toFixed(v >= 100 ? 0 : v >= 10 ? 1 : 2)} ${units[i]}`;
  }

  async function loadUsage() {
    const id = window.__currentCrawlerId;
    if (!id) return;
    try {
      const data = await fetchJSON(`/pa/api/me/${id}/logs/usage`);
      document.getElementById('usage-lines').value = `${data.lines}${data.max_lines ? ` / ${data.max_lines}` : ''}`;
      document.getElementById('usage-bytes').value = `${formatBytes(data.bytes)}${data.max_bytes ? ` / ${formatBytes(data.max_bytes)}` : ''}`;
      const ll = document.getElementById('limit-lines');
      const lb = document.getElementById('limit-bytes');
      ll.value = (data.max_lines ?? '');
      lb.value = (data.max_bytes ?? '');
    } catch (error) {
      alert(error.message);
    }
  }

  async function saveLimits() {
    const id = window.__currentCrawlerId;
    if (!id) return;
    const ll = document.getElementById('limit-lines').value;
    const lb = document.getElementById('limit-bytes').value;
    const payload = {};
    if (ll !== '') payload.log_max_lines = Number(ll);
    if (lb !== '') payload.log_max_bytes = Number(lb);
    try {
      await fetchJSON(`/pa/api/me/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      await loadUsage();
      alert('已保存上限设置');
    } catch (error) {
      alert(error.message);
    }
  }

  async function clearLogs() {
    const id = window.__currentCrawlerId;
    if (!id) return;
    if (!confirm('确认清空该项目的所有日志？此操作不可恢复。')) return;
    try {
      await fetchJSON(`/pa/api/me/${id}/logs`, { method: 'DELETE' });
      await loadUsage();
      alert('日志已清空');
    } catch (error) {
      alert(error.message);
    }
  }

  document.getElementById('usage-refresh').addEventListener('click', loadUsage);
  document.getElementById('usage-save').addEventListener('click', saveLimits);
  document.getElementById('usage-clear').addEventListener('click', clearLogs);

  // ---- 详情页统计 ----
  function renderLevelOptions(select, selected) {
    select.innerHTML = (window.LOG_LEVEL_OPTIONS || []).slice().sort((a, b) => a.code - b.code)
      .map(opt => `<option value="${opt.code}" ${Number(selected) === Number(opt.code) ? 'selected' : ''}>${opt.code} - ${opt.name}</option>`).join('');
  }
  renderLevelOptions(document.getElementById('dstats-min'), 0);
  renderLevelOptions(document.getElementById('dstats-max'), 50);

  let __dstats = null;
  async function loadDetailStats() {
    const id = window.__currentCrawlerId; if (!id) return;
    const h = Math.max(1, Math.min(168, Number(document.getElementById('dstats-hours').value || 24)));
    const k = Math.max(2, Math.min(240, Number(document.getElementById('dstats-buckets').value || 24)));
    const min = Number(document.getElementById('dstats-min').value || 0);
    const max = Number(document.getElementById('dstats-max').value || 50);
    const q = (document.getElementById('dstats-query').value || '').trim();
    const regex = document.getElementById('dstats-regex').checked ? 1 : 0;
    const gran = document.getElementById('dstats-granularity').value || 'auto';
    const url = `/pa/api/me/${id}/logs/stats?hours=${h}&buckets=${k}&min_level=${min}&max_level=${max}&granularity=${encodeURIComponent(gran)}${q ? `&q=${encodeURIComponent(q)}` : ''}${regex ? '&regex=1' : ''}`;
    try {
      const res = await fetch(url);
      if (!res.ok) return;
      const data = await res.json();
      __dstats = data;
      const chart = document.getElementById('dstats-chart');
      const empty = document.getElementById('dstats-empty');
      const meta = document.getElementById('dstats-meta');
      chart.innerHTML = '';
      if (!data.buckets || !data.buckets.length) {
        empty.style.display = '';
        meta.textContent = '';
        return;
      }
      empty.style.display = 'none';
      const maxv = Math.max(1, ...data.buckets.map(b => b.count || 0));
      let peakIdx = 0; let peakVal = 0;
      data.buckets.forEach((b, idx) => { if ((b.count || 0) > peakVal) { peakVal = b.count || 0; peakIdx = idx; } });
      const barWidth = Math.max(2, Math.floor(260 / data.buckets.length));
      data.buckets.forEach((b, idx) => {
        const v = Number(b.count || 0);
        const bar = document.createElement('div');
        bar.title = `${new Date(b.t).toLocaleString()}\n${v} 条`;
        bar.style.cssText = `width:${barWidth}px;height:${Math.max(2, Math.floor(v / maxv * 100))}%;background:${idx===peakIdx?'#b91c1c':'var(--color-primary)'};opacity:${v ? 1 : 0.25};`;
        chart.appendChild(bar);
      });
      meta.textContent = `总计 ${data.total} 条，峰值 ${peakVal}（${new Date(data.buckets[peakIdx].t).toLocaleString()}） | 时间范围：${new Date(data.start).toLocaleString()} ~ ${new Date(data.end).toLocaleString()}（采样 ${data.scanned} 条）`;
    } catch (_) {}
  }
  document.getElementById('dstats-refresh').addEventListener('click', loadDetailStats);

  function exportDetailCSV() {
    if (!__dstats || !__dstats.buckets) return;
    const rows = [['time','count']].concat(__dstats.buckets.map(b => [b.t, String(b.count||0)]));
    const csv = rows.map(r => r.map(x => (/[,\"]/.test(x) ? '"'+String(x).replace(/\"/g,'""')+'"' : x)).join(',')).join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `crawler-${window.__currentCrawlerId}-stats.csv`; a.click();
  }
  function exportDetailPNG() {
    if (!__dstats || !__dstats.buckets) return;
    const canvas = document.getElementById('dstats-canvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height; ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-background') || '#fff'; ctx.fillRect(0,0,W,H);
    const margin = 32; const chartW = W - margin*2; const chartH = H - margin*2;
    const maxv = Math.max(1, ...__dstats.buckets.map(b => b.count || 0));
    const n = __dstats.buckets.length; const bw = Math.max(1, Math.floor(chartW / n * 0.8)); const gap = Math.max(1, Math.floor(chartW / n * 0.2));
    const primary = getComputedStyle(document.body).getPropertyValue('--color-primary') || '#4f46e5';
    let peakIdx = 0; let peakVal = 0;
    __dstats.buckets.forEach((b, i) => { if ((b.count||0) > peakVal) { peakVal = b.count||0; peakIdx = i; } });
    for (let i=0;i<n;i++) {
      const v = Number(__dstats.buckets[i].count || 0);
      const x = margin + i*(bw+gap);
      const h = Math.max(1, Math.floor(v/maxv*chartH));
      ctx.fillStyle = (i===peakIdx ? '#b91c1c' : primary);
      ctx.globalAlpha = v ? 1 : 0.25;
      ctx.fillRect(x, margin + chartH - h, bw, h);
    }
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#333'; ctx.font = '12px sans-serif';
    ctx.fillText(`Total: ${__dstats.total}  Peak: ${peakVal}`, margin, margin-8);
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href = url; a.download = `crawler-${window.__currentCrawlerId}-stats.png`; a.click();
  }
  document.getElementById('dstats-export-csv').addEventListener('click', exportDetailCSV);
  document.getElementById('dstats-export-png').addEventListener('click', exportDetailPNG);

  const linkForm = document.getElementById('link-form');
  const linkHint = document.getElementById('link-hint');

  linkForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = {
      target_type: document.getElementById('link-target-type').value,
      target_id: Number(document.getElementById('link-target-id').value),
      slug: document.getElementById('link-slug').value || null,
      allow_logs: document.getElementById('link-logs').checked,
      description: document.getElementById('link-desc').value || null,
    };
    try {
      const res = await fetchJSON('/pa/api/links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      linkHint.textContent = `创建成功：${res.slug}`;
      linkHint.style.color = 'var(--color-primary)';
      linkForm.reset();
      refreshLinks();
    } catch (error) {
      linkHint.textContent = error.message;
      linkHint.style.color = '#b91c1c';
    }
  });

  async function refreshLinks() {
    const data = await fetchJSON('/pa/api/links');
    const tbody = document.querySelector('#links-table tbody');
    tbody.innerHTML = data.map(link => {
      const linkUrl = `/pa/${link.slug}`;
      const allowLogs = link.allow_logs ? '是' : '否';
      let target;
      if (link.target_type === 'crawler') {
        target = `Crawler #${link.crawler_local_id}`;
      } else if (link.target_type === 'api_key') {
        target = `API Key #${link.api_key_local_id}`;
      } else if (link.target_type === 'group') {
        target = `Group ${link.group_slug ?? ''} (#${link.group_id ?? '-'})`;
      } else {
        target = '-';
      }
      return `<tr><td><a href="${linkUrl}" target="_blank">${link.slug}</a></td><td>${link.target_type}</td><td>${target}</td><td>${allowLogs}</td><td>${new Date(link.created_at).toLocaleString()}</td><td><button class="text" onclick="deleteLink(${link.id})">删除</button></td></tr>`;
    }).join('');
  }

  window.refreshLinks = refreshLinks;

  window.deleteLink = async (id) => {
    if (!confirm('确认删除该链接？')) return;
    await fetchJSON(`/pa/api/links/${id}`, { method: 'DELETE' });
    refreshLinks();
  };


  function resetFilters() {
    Array.from(crawlersSelect.options).forEach(opt => (opt.selected = true));
    document.getElementById('log-start').value = '';
    document.getElementById('log-end').value = '';
    minSelect.value = 0;
    maxSelect.value = 50;
    document.getElementById('log-limit').value = 200;
    const dev = document.getElementById('log-device'); if (dev) dev.value = '';
    const ipf = document.getElementById('log-ip'); if (ipf) ipf.value = '';
    loadLogs();
  }

  async function loadLogs() {
    const ids = Array.from(crawlersSelect.selectedOptions).map(opt => opt.value);
    const params = new URLSearchParams();
    if (ids.length) params.append('crawler_ids', ids.join(','));
    const start = document.getElementById('log-start').value;
    const end = document.getElementById('log-end').value;
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    params.append('min_level', minSelect.value);
    params.append('max_level', maxSelect.value);
    params.append('limit', document.getElementById('log-limit').value || '200');
    const dev = document.getElementById('log-device')?.value;
    const ipf = document.getElementById('log-ip')?.value;
    if (dev) params.append('device', dev.trim());
    if (ipf) params.append('ip', ipf.trim());
    try {
      // 将关键字/正则传给后端进行初筛
      const queryInput = document.getElementById('log-query');
      const regexMode = document.getElementById('log-regex-mode');
      if (queryInput && queryInput.value) params.append('q', queryInput.value.trim());
      if (regexMode && regexMode.checked) params.append('regex', '1');
      const data = await fetchJSON(`/pa/api/me/logs?${params.toString()}`);
      const container = document.getElementById('log-list');
      const empty = document.getElementById('log-empty');
      if (!data.length) {
        container.innerHTML = '';
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';
      // 关键字/正则二次过滤（前端）
      const queryInput = document.getElementById('log-query');
      const regexMode = document.getElementById('log-regex-mode');
      let filtered = data;
      if (queryInput && queryInput.value && typeof queryInput.value === 'string') {
        const q = queryInput.value.trim();
        try {
          if (regexMode && regexMode.checked) {
            const re = new RegExp(q);
            filtered = filtered.filter(item => re.test(String(item.message || '')));
          } else {
            const needle = q.toLowerCase();
            filtered = filtered.filter(item => String(item.message || '').toLowerCase().includes(needle));
          }
        } catch (_) {
          const needle = q.toLowerCase();
          filtered = filtered.filter(item => String(item.message || '').toLowerCase().includes(needle));
        }
      }
      const levelMap = Object.fromEntries(levelOptions.map(item => [item.code, item.name]));
      container.innerHTML = filtered.map(item => {
        const code = Number(item.level_code || 20);
        const badgeClass = `badge level-${code}`;
        const levelText = levelMap[code] || item.level;
        const crawler = item.crawler_name || `#${item.crawler_local_id}`;
        const ip = item.source_ip || '-';
        const device = item.device_name ? `<span class=\"hint\">设备: ${item.device_name}</span>` : '';
        return `<div class=\"log-item\"><div class=\"log-head\"><span>${new Date(item.ts).toLocaleString()}</span><div class=\"table-actions\" style=\"gap:8px;\"><span class=\"badge ${badgeClass}\">${levelText}</span><span class=\"hint\">${crawler}</span><span class=\"hint\">IP: ${ip}</span>${device}</div></div><div>${item.message}</div></div>`;
      }).join('');
    } catch (error) {
      alert(error.message);
    }
  }

  window.loadLogs = loadLogs;
  window.resetFilters = resetFilters;

  // ---- 页面增强：隐藏/取消隐藏/删除/放大/详情 ----
  window.hideCrawler = async (id) => {
    if (!confirm('确认隐藏该工程？隐藏后将不在主列表显示。')) return;
    try {
      await fetchJSON(`/pa/api/me/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_hidden: true })
      });
      await loadCrawlers();
      alert('已隐藏');
    } catch (error) {
      alert(error.message);
    }
  };

  window.unhideCrawler = async (id) => {
    try {
      await fetchJSON(`/pa/api/me/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_hidden: false })
      });
      await loadCrawlers();
      alert('已取消隐藏');
    } catch (error) {
      alert(error.message);
    }
  };

  window.deleteCrawler = async (id) => {
    if (!confirm('确认删除工程？将连带清空运行、心跳、日志与命令，且不可恢复！')) return;
    try {
      await fetchJSON(`/pa/api/me/${id}`, { method: 'DELETE' });
      // 如当前详情是该工程，关闭详情
      if (window.__currentCrawlerId === id) {
        document.getElementById('detail').style.display = 'none';
        window.__currentCrawlerId = null;
      }
      await loadCrawlers();
      alert('工程已删除');
    } catch (error) {
      alert(error.message);
    }
  };

  window.toggleLogFullscreen = () => {
    const el = document.getElementById('log-list');
    if (!el) return;
    const fs = el.getAttribute('data-fs') === '1';
    if (!fs) {
      el.style.position = 'fixed';
      el.style.top = '64px';
      el.style.left = '24px';
      el.style.right = '24px';
      el.style.bottom = '24px';
      el.style.zIndex = '999';
      el.style.background = 'var(--color-surface)';
      el.style.padding = '12px';
      el.style.overflow = 'auto';
      el.setAttribute('data-fs', '1');
    } else {
      el.removeAttribute('style');
      el.removeAttribute('data-fs');
    }
  };

  window.gotoLogDetail = () => {
    const id = window.__currentCrawlerId;
    if (!id) {
      alert('请先在爬虫列表中点击某一项的“详情”。');
      return;
    }
    // 跳转到支持直达详情的路由
    window.location.href = `/dashboard/crawlers/${id}`;
  };

  // 初次加载：
  loadKeys();
  loadCrawlers().then(() => {
    // 若后端注入了初始详情 ID，则自动展开
    const initId = (window.INIT_CRAWLER_ID || null);
    if (initId) {
      try { window.showDetail(initId, ''); } catch(_) {}
    }
    return loadLogs();
  });
  refreshLinks();
})();
</script>
{% endblock %}
