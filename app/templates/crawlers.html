{% extends "base.html" %}
{% block content %}
  <section class="page-header">
    <h2>爬虫监控中心</h2>
    <p>通过统一的 /pa 接入上报运行状态，支持快捷匿名链接与日志筛选。</p>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>API Key 管理</h3>
      <div class="table-actions">
        <button onclick="createKey()">生成新 Key</button>
      </div>
    </div>
    <div class="table-scroll">
      <table class="data-table" id="keys-table">
        <thead><tr><th>ID（本账号）</th><th>Key</th><th>名称</th><th>状态</th><th>最近使用</th><th>公开</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="hint">接口路径已迁移至 <code>/pa/api</code>，请在 SDK 中更新基础地址。</p>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>爬虫列表</h3>
    </div>
    <div class="table-scroll">
      <table class="data-table" id="crawlers-table">
        <thead><tr><th>ID（本账号）</th><th>名称</th><th>最近心跳</th><th>来源 IP</th><th>公开</th><th>快捷链接</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>快捷访问链接</h3>
      <div class="table-actions">
        <button type="button" onclick="refreshLinks()">刷新</button>
      </div>
    </div>
    <form id="link-form" class="form-grid">
      <label for="link-target-type">目标类型</label>
      <select id="link-target-type" name="target_type">
        <option value="crawler">爬虫</option>
        <option value="api_key">API Key</option>
        <option value="group">分组</option>
      </select>
      <label for="link-target-id">目标 ID（本账号序号）</label>
      <input id="link-target-id" name="target_id" type="number" required />
      <label for="link-slug">自定义路径（可选）</label>
      <input id="link-slug" name="slug" type="text" placeholder="至少 6 位，例如 mybot01" />
      <label>
        <input type="checkbox" id="link-logs" name="allow_logs" checked /> 允许访问日志
      </label>
      <label for="link-desc">备注说明</label>
      <input id="link-desc" name="description" type="text" placeholder="例如：合作方查看" />
      <button type="submit">生成快捷链接</button>
      <div class="hint" id="link-hint"></div>
    </form>
    <div class="table-scroll">
      <table class="data-table" id="links-table">
        <thead><tr><th>Slug</th><th>类型</th><th>目标</th><th>日志</th><th>创建时间</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="hint">访问地址示例：<code>{{ request.url.scheme }}://{{ request.url.netloc }}/pa/&lt;slug&gt;</code></p>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>日志筛选</h3>
      <div class="table-actions">
        <button class="text" type="button" onclick="resetFilters()">重置</button>
        <button type="button" onclick="loadLogs()">刷新</button>
      </div>
    </div>
    <div class="filters">
      <div>
        <label for="log-crawlers">选择爬虫</label>
        <select id="log-crawlers" multiple></select>
      </div>
      <div>
        <label for="log-start">开始日期</label>
        <input type="date" id="log-start" />
      </div>
      <div>
        <label for="log-end">结束日期</label>
        <input type="date" id="log-end" />
      </div>
      <div>
        <label for="log-min-level">最小等级</label>
        <select id="log-min-level"></select>
      </div>
      <div>
        <label for="log-max-level">最大等级</label>
        <select id="log-max-level"></select>
      </div>
      <div>
        <label for="log-limit">最多条数</label>
        <input type="number" id="log-limit" min="1" max="500" value="200" />
      </div>
    </div>
    <div class="log-list" id="log-list"></div>
    <div class="empty-hint" id="log-empty" style="display:none;">暂无日志，可调整筛选后再次查询。</div>
  </section>

  <section class="card" id="detail" style="display:none;">
    <div class="card-header">
      <h3 id="detail-title">爬虫详情</h3>
    </div>
    <div class="grid">
      <div>
        <h4>最近运行</h4>
        <div class="table-scroll">
          <table class="data-table">
            <thead><tr><th>ID</th><th>状态</th><th>开始</th><th>结束</th><th>来源 IP</th></tr></thead>
            <tbody id="runs-body"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h4>最近日志</h4>
        <div class="log-list" id="logs-list"></div>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const levelOptions = (window.LOG_LEVEL_OPTIONS || []).slice().sort((a, b) => a.code - b.code);
  const minSelect = document.getElementById('log-min-level');
  const maxSelect = document.getElementById('log-max-level');
  const crawlersSelect = document.getElementById('log-crawlers');

  function renderLevelOptions(select, selected) {
    select.innerHTML = levelOptions.map(opt => `<option value="${opt.code}" ${Number(selected) === Number(opt.code) ? 'selected' : ''}>${opt.code} - ${opt.name}</option>`).join('');
  }
  renderLevelOptions(minSelect, 0);
  renderLevelOptions(maxSelect, 50);

  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.detail || `请求失败(${res.status})`);
    }
    return res.json();
  }

  window.createKey = async () => {
    try {
      await fetchJSON('/api/keys', { method: 'POST' });
      loadKeys();
    } catch (error) {
      alert(error.message);
    }
  }

  async function loadKeys() {
    const data = await fetchJSON('/api/keys');
    const tbody = document.querySelector('#keys-table tbody');
    tbody.innerHTML = data.map(key => {
      const last = key.last_used_at ? new Date(key.last_used_at).toLocaleString() : '-';
      const status = key.active ? '启用' : '禁用';
      const publicFlag = key.is_public ? '是' : '否';
      const name = key.name || '-';
      return `<tr>
        <td title="全局 ID: ${key.id}">${key.local_id}</td>
        <td><code>${key.key}</code></td>
        <td>${name}</td>
        <td>${status}</td>
        <td>${last}</td>
        <td>${publicFlag}</td>
        <td>
          <button class="text" onclick="toggleKey(${key.id}, ${key.active ? 'false' : 'true'})">${key.active ? '禁用' : '启用'}</button>
          <button class="text" onclick="deleteKey(${key.id})">删除</button>
        </td>
      </tr>`;
    }).join('');
  }

  window.toggleKey = async (id, next) => {
    const normalized = typeof next === 'boolean' ? next : String(next).toLowerCase() === 'true';
    const payload = { active: normalized };
    try {
      await fetchJSON(`/api/keys/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      loadKeys();
    } catch (error) {
      alert(error.message);
    }
  };

  window.deleteKey = async (id) => {
    if (!confirm('确认删除此 Key?')) return;
    try {
      await fetchJSON(`/api/keys/${id}`, { method: 'DELETE' });
      loadKeys();
    } catch (error) {
      alert(error.message);
    }
  };

  async function loadCrawlers() {
    const data = await fetchJSON('/pa/api/me');
    crawlersSelect.innerHTML = data.map(crawler => {
      const localId = crawler.local_id ?? crawler.id;
      const displayName = crawler.name || '未命名爬虫';
      return `<option value="${crawler.id}" selected>[#${localId}] ${displayName}</option>`;
    }).join('');
    const tbody = document.querySelector('#crawlers-table tbody');
    tbody.innerHTML = data.map(crawler => {
      const hb = crawler.last_heartbeat ? new Date(crawler.last_heartbeat).toLocaleString() : '-';
      const slug = crawler.public_slug ? `<code>${crawler.public_slug}</code>` : '-';
      const ip = crawler.last_source_ip || '-';
      const localId = crawler.local_id ?? crawler.id;
      const displayName = crawler.name || '未命名爬虫';
      const safeName = displayName.replace(/'/g, "");
      return `<tr>
        <td title="全局 ID: ${crawler.id}">${localId}</td>
        <td>${displayName}</td>
        <td>${hb}</td>
        <td>${ip}</td>
        <td>${crawler.is_public ? '是' : '否'}</td>
        <td>${slug}</td>
        <td><button class="text" onclick="showDetail(${crawler.id}, '${safeName}')">详情</button></td>
      </tr>`;
    }).join('');
  }

  window.showDetail = async (id, name) => {
    document.getElementById('detail').style.display = '';
    document.getElementById('detail-title').textContent = `#${id} - ${name}`;
    const runs = await fetchJSON(`/pa/api/me/${id}/runs`);
    const logs = await fetchJSON(`/pa/api/me/${id}/logs?limit=50`);
    const runsBody = document.getElementById('runs-body');
    runsBody.innerHTML = runs.map(run => `<tr><td>${run.id}</td><td>${run.status}</td><td>${new Date(run.started_at).toLocaleString()}</td><td>${run.ended_at ? new Date(run.ended_at).toLocaleString() : '-'}</td><td>${run.source_ip || '-'}</td></tr>`).join('');
    const levelMap = Object.fromEntries(levelOptions.map(item => [item.code, item.name]));
    const logsList = document.getElementById('logs-list');
    logsList.innerHTML = logs.map(item => {
      const level = levelMap[item.level_code] || item.level;
      return `<div class="log-item"><div class="log-head"><span>${new Date(item.ts).toLocaleString()}</span><span class="badge level-${item.level_code}">${level}</span></div><div>${item.message}</div></div>`;
    }).join('');
  };

  const linkForm = document.getElementById('link-form');
  const linkHint = document.getElementById('link-hint');

  linkForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = {
      target_type: document.getElementById('link-target-type').value,
      target_id: Number(document.getElementById('link-target-id').value),
      slug: document.getElementById('link-slug').value || null,
      allow_logs: document.getElementById('link-logs').checked,
      description: document.getElementById('link-desc').value || null,
    };
    try {
      const res = await fetchJSON('/pa/api/links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      linkHint.textContent = `创建成功：${res.slug}`;
      linkHint.style.color = 'var(--color-primary)';
      linkForm.reset();
      refreshLinks();
    } catch (error) {
      linkHint.textContent = error.message;
      linkHint.style.color = '#b91c1c';
    }
  });

  async function refreshLinks() {
    const data = await fetchJSON('/pa/api/links');
    const tbody = document.querySelector('#links-table tbody');
    tbody.innerHTML = data.map(link => {
      const linkUrl = `/pa/${link.slug}`;
      const allowLogs = link.allow_logs ? '是' : '否';
      let target;
      if (link.target_type === 'crawler') {
        target = `Crawler #${link.crawler_local_id ?? link.crawler_id ?? '-'}`;
      } else if (link.target_type === 'api_key') {
        target = `API Key #${link.api_key_local_id ?? link.api_key_id ?? '-'}`;
      } else if (link.target_type === 'group') {
        target = `Group ${link.group_slug ?? ''} (#${link.group_id ?? '-'})`;
      } else {
        target = '-';
      }
      return `<tr><td><a href="${linkUrl}" target="_blank">${link.slug}</a></td><td>${link.target_type}</td><td>${target}</td><td>${allowLogs}</td><td>${new Date(link.created_at).toLocaleString()}</td><td><button class="text" onclick="deleteLink(${link.id})">删除</button></td></tr>`;
    }).join('');
  }

  window.refreshLinks = refreshLinks;

  window.deleteLink = async (id) => {
    if (!confirm('确认删除该链接？')) return;
    await fetchJSON(`/pa/api/links/${id}`, { method: 'DELETE' });
    refreshLinks();
  };


  function resetFilters() {
    Array.from(crawlersSelect.options).forEach(opt => (opt.selected = true));
    document.getElementById('log-start').value = '';
    document.getElementById('log-end').value = '';
    minSelect.value = 0;
    maxSelect.value = 50;
    document.getElementById('log-limit').value = 200;
    loadLogs();
  }

  async function loadLogs() {
    const ids = Array.from(crawlersSelect.selectedOptions).map(opt => opt.value);
    const params = new URLSearchParams();
    if (ids.length) params.append('crawler_ids', ids.join(','));
    const start = document.getElementById('log-start').value;
    const end = document.getElementById('log-end').value;
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    params.append('min_level', minSelect.value);
    params.append('max_level', maxSelect.value);
    params.append('limit', document.getElementById('log-limit').value || '200');
    try {
      const data = await fetchJSON(`/pa/api/me/logs?${params.toString()}`);
      const container = document.getElementById('log-list');
      const empty = document.getElementById('log-empty');
      if (!data.length) {
        container.innerHTML = '';
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';
      const levelMap = Object.fromEntries(levelOptions.map(item => [item.code, item.name]));
      container.innerHTML = data.map(item => {
        const code = Number(item.level_code || 20);
        const badgeClass = `badge level-${code}`;
        const levelText = levelMap[code] || item.level;
        const crawler = item.crawler_name || `#${item.crawler_local_id ?? item.crawler_id}`;
        const ip = item.source_ip || '-';
        return `<div class="log-item"><div class="log-head"><span>${new Date(item.ts).toLocaleString()}</span><div class="table-actions" style="gap:8px;"><span class="badge ${badgeClass}">${levelText}</span><span class="hint">${crawler}</span><span class="hint">IP: ${ip}</span></div></div><div>${item.message}</div></div>`;
      }).join('');
    } catch (error) {
      alert(error.message);
    }
  }

  window.loadLogs = loadLogs;
  window.resetFilters = resetFilters;

  loadKeys();
  loadCrawlers().then(loadLogs);
  refreshLinks();
})();
</script>
{% endblock %}
