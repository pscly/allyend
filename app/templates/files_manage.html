{% extends "base.html" %}

{% macro public_files_card() %}
  <section class="card card--surface" data-aos="fade-up" data-aos-delay="200">
    <div class="card-header">
      <div>
        <h3><i class="bx bx-world"></i> 公开文件</h3>
        <p class="card-subtitle">浏览团队公开共享的资料，支持直接下载。</p>
      </div>
      <button type="button" id="refresh-public" class="text"><i class="bx bx-refresh"></i><span>刷新</span></button>
    </div>
    <div class="table-scroll">
      <table class="data-table" id="public-files-table">
        <thead>
          <tr>
            <th>名称</th>
            <th>大小</th>
            <th>上传时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
{% endmacro %}

{% block content %}
  <section class="page-header" data-aos="fade-down">
    <div class="header-lead">
      <h2><i class="bx bx-server"></i> 文件管理</h2>
      <p>在这里管理团队文件，支持分组共享与 API 令牌自动同步。</p>
    </div>
    {% if user %}
    <div class="header-cta">
      <span class="badge badge--success"><i class="bx bx-user"></i> 已登录</span>
      <p>当前会话已启用 Cookie，直接使用下方「上传到我的空间」即可，无需额外 API 令牌。</p>
    </div>
    {% endif %}
  </section>

  {% if user %}
  <div class="section-group two-column">
    <section class="card card--accent" data-aos="fade-up" data-aos-delay="70">
      <div class="card-header">
        <div>
          <h3><i class="bx bx-cloud-upload"></i> 上传到我的空间</h3>
          <p class="card-subtitle">选择可见性：仅自己 / 分组 / 公开。</p>
        </div>
      </div>
      <form id="user-upload" class="form-grid">
        <label for="user-file">选择文件</label>
        <input id="user-file" name="file" type="file" required />

        <label for="user-name">显示名称</label>
        <input id="user-name" name="file_name" type="text" placeholder="示例：日报.xlsx" />

        <label for="user-visibility">可见性</label>
        <select id="user-visibility" name="visibility">
          <option value="private">仅自己</option>
          <option value="group">分组内</option>
          <option value="public">公开</option>
        </select>

        <label for="user-desc">备注说明</label>
        <textarea id="user-desc" name="description" rows="2" placeholder="文件用途说明"></textarea>

        <p class="form-note">未填写显示名称时，系统会自动使用原始文件名。</p>
        <button type="submit"><i class="bx bx-send"></i><span>上传</span></button>
        <div class="hint" id="user-hint"></div>
      </form>
    </section>

    <section class="card card--surface" data-aos="fade-up" data-aos-delay="140">
      <div class="card-header">
        <div>
          <h3><i class="bx bx-key"></i> API 令牌</h3>
          <p class="card-subtitle">统一使用 <code>up-*</code> 前缀，可自定义后缀或自动生成。</p>
        </div>
        <button type="button" id="refresh-tokens" class="text"><i class="bx bx-refresh"></i><span>刷新</span></button>
      </div>
      <form id="token-create" class="form-grid">
        <label for="token-value">自定义令牌</label>
        <input id="token-value" name="token" type="text" placeholder="例如：up-data-sync 或 data-sync" />
        <p class="form-note">留空将自动生成；若未填写前缀，系统会自动补齐 <code>up-</code>。</p>

        <label for="token-name">令牌名称</label>
        <input id="token-name" name="name" type="text" placeholder="例如：CI 同步" />

        <label for="token-ips">允许 IP（逗号分隔）</label>
        <input id="token-ips" name="allowed_ips" type="text" placeholder="示例：127.0.0.1, 192.168.1.10" />

        <label for="token-cidrs">允许网段（逗号分隔）</label>
        <input id="token-cidrs" name="allowed_cidrs" type="text" placeholder="示例：10.0.0.0/24" />

        <button type="submit"><i class="bx bx-plus-circle"></i><span>创建令牌</span></button>
        <div class="hint" id="token-hint"></div>
      </form>
      <div class="table-scroll">
        <table class="data-table" id="token-table">
          <thead>
            <tr><th>令牌</th><th>名称</th><th>限制</th><th>状态</th><th>操作</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint">上传：<code>POST /files/&lt;token&gt;/up</code>（FormData 至少包含 <code>file</code> 字段），列出：<code>GET /files/&lt;token&gt;</code></p>
    </section>
  </div>

  <div class="section-group two-column">
    <section class="card" data-aos="fade-up" data-aos-delay="180">
      <div class="card-header">
        <div>
          <h3><i class="bx bx-folder"></i> 我的文件</h3>
          <p class="card-subtitle">按可见性筛选个人文件，支持快速切换公开范围或禁用下载。</p>
        </div>
        <div class="table-actions">
          <select id="file-scope">
            <option value="private">仅自己</option>
            <option value="group">分组内</option>
            <option value="public">公开</option>
            <option value="disabled">已禁用</option>
          </select>
          <button type="button" id="refresh-files" class="text"><i class="bx bx-refresh"></i><span>刷新</span></button>
        </div>
      </div>
      <div class="table-scroll">
        <table class="data-table" id="my-files-table">
          <thead><tr><th>名称</th><th>可见性 / 状态</th><th>大小</th><th>上传时间</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint">下拉框可即时调整可见性，选择“禁用下载”可阻止他人访问但本人仍可下载。</p>
    </section>

    {{ public_files_card() }}
  </div>
  {% else %}
  <section class="card card--surface" data-aos="fade-up" data-aos-delay="60">
    <div class="card-header">
      <div>
        <h3><i class="bx bx-lock"></i> 需要登录</h3>
        <p class="card-subtitle">请登录后上传或管理文件，未登录仍可浏览公开文件列表。</p>
      </div>
    </div>
    <p class="hint">登录后可以使用 Cookie 直接上传，无需额外 API 令牌。</p>
  </section>
  {{ public_files_card() }}
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
(() => {
  const userPresent = {{ 'true' if user else 'false' }};
  const visibilityText = { private: '仅自己', group: '分组内', public: '公开', disabled: '禁用下载' };
  const visibilityOptions = ['private', 'group', 'public', 'disabled'];

  const escapeHTML = (value) => {
    if (value === null || value === undefined) return '';
    return String(value).replace(/[&<>"']/g, (match) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
    })[match]);
  };

  const toastIcons = {
    success: 'bx-check-circle',
    error: 'bx-x-circle',
    info: 'bx-info-circle',
  };

  const ensureToastContainer = () => {
    let container = document.getElementById('toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'toast-container';
      document.body.appendChild(container);
    }
    return container;
  };

  const showToast = (message, type = 'info', options = {}) => {
    if (!message) return;
    const { duration = 3200 } = options;
    const variant = ['success', 'error', 'info'].includes(type) ? type : 'info';
    const container = ensureToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast toast--${variant}`;
    toast.innerHTML = `
      <i class="bx ${toastIcons[variant] || toastIcons.info}"></i>
      <span class="toast__message">${escapeHTML(message)}</span>
    `;
    container.appendChild(toast);

    requestAnimationFrame(() => {
      toast.classList.add('is-visible');
    });

    const removeToast = () => {
      toast.classList.add('is-leaving');
      toast.addEventListener('transitionend', () => {
        toast.remove();
        if (!container.childElementCount) {
          container.remove();
        }
      }, { once: true });
    };

    const timer = setTimeout(removeToast, Math.max(1800, duration));
    toast.addEventListener('click', () => {
      clearTimeout(timer);
      removeToast();
    }, { once: true });
  };
  const formatSize = (bytes) => {
    if (bytes === null || bytes === undefined) return '-';
    if (bytes < 1024) return `${bytes} B`;
    const units = ['KB', 'MB', 'GB', 'TB'];
    let size = bytes / 1024;
    let unitIndex = 0;
    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex++;
    }
    return `${size.toFixed(1)} ${units[unitIndex]}`;
  };

  const formatDateTime = (value) => {
    if (!value) return '-';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '-';
    return date.toLocaleString();
  };

  async function fetchJSON(url, options = {}) {
    const config = { credentials: 'include', ...options };
    const response = await fetch(url, config);
    const contentType = response.headers.get('content-type') || '';
    let payload = null;
    if (response.status !== 204) {
      if (contentType.includes('application/json')) {
        payload = await response.json().catch(() => null);
      } else {
        const text = await response.text();
        payload = text || null;
      }
    }
    if (!response.ok) {
      const detail = payload && typeof payload === 'object' ? payload.detail : null;
      throw new Error(detail || `请求失败(${response.status})`);
    }
    return payload;
  }

  async function loadPublicFiles() {
    try {
      const data = await fetchJSON('/files/public?limit=100');
      const records = Array.isArray(data) ? data : [];
      const tbody = document.querySelector('#public-files-table tbody');
      if (!tbody) return;
      if (!records.length) {
        tbody.innerHTML = '<tr><td class="table-empty" colspan="4">暂无公开文件</td></tr>';
        return;
      }
      tbody.innerHTML = records.map(file => {
        const link = file.download_url || `/files/${file.id}/download`;
        return `<tr>
          <td>${escapeHTML(file.original_name)}</td>
          <td>${formatSize(file.size_bytes)}</td>
          <td>${formatDateTime(file.created_at)}</td>
          <td><a href="${link}" target="_blank">下载</a></td>
        </tr>`;
      }).join('');
    } catch (error) {
      console.error(error);
    }
  }

  if (userPresent) {
    const uploadForm = document.getElementById('user-upload');
    const uploadHint = document.getElementById('user-hint');
    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(uploadForm);
      const displayName = formData.get('file_name');
      if (typeof displayName === 'string' && !displayName.trim()) {
        formData.delete('file_name');
      }
      const description = formData.get('description');
      if (typeof description === 'string' && !description.trim()) {
        formData.delete('description');
      }
      try {
        await fetchJSON('/files/me/up', { method: 'POST', body: formData });
        uploadHint.textContent = '上传成功';
        uploadHint.style.color = 'var(--color-primary)';
        showToast('上传成功，列表已刷新。', 'success');
        uploadForm.reset();
        loadMyFiles();
        loadPublicFiles();
      } catch (error) {
        uploadHint.textContent = error.message;
        uploadHint.style.color = '#b91c1c';
        showToast(`上传失败：${error.message}`, 'error');
      }
    });


    const loadMyFiles = async () => {
      const scope = document.getElementById('file-scope').value;
      try {
        const data = await fetchJSON(`/files/me?scope=${scope}`);
        const records = Array.isArray(data) ? data : [];
        const tbody = document.querySelector('#my-files-table tbody');
        if (!tbody) return;
        if (!records.length) {
          tbody.innerHTML = '<tr><td class="table-empty" colspan="5">暂无文件</td></tr>';
          return;
        }
        tbody.innerHTML = records.map(file => {
          const link = file.download_url || `/files/${file.id}/download`;
          const visibilityLabel = visibilityText[file.visibility] || file.visibility;
          const badgeClass = `badge badge--${file.visibility}`;
          const options = visibilityOptions.map(option => {
            const selected = option === file.visibility ? ' selected' : '';
            return `<option value="${option}"${selected}>${visibilityText[option]}</option>`;
          }).join('');
          const downloadLabel = file.visibility === 'disabled' ? '仅本人可下载' : '下载';
          const downloadTitle = file.visibility === 'disabled' ? '文件已禁用对外下载' : '打开新标签下载';
          return `<tr>
            <td>${escapeHTML(file.original_name)}</td>
            <td>
              <div class="visibility-control">
                <span class="${badgeClass}">${visibilityLabel}</span>
                <select class="visibility-select" data-file-visibility="${file.id}" data-current-visibility="${file.visibility}">
                  ${options}
                </select>
              </div>
            </td>
            <td>${formatSize(file.size_bytes)}</td>
            <td>${formatDateTime(file.created_at)}</td>
            <td class="file-actions">
              <a href="${link}" target="_blank" title="${downloadTitle}">${downloadLabel}</a>
              <button class="text" data-file="${file.id}"><i class="bx bx-trash"></i>删除</button>
            </td>
          </tr>`;
        }).join('');
        tbody.querySelectorAll('select[data-file-visibility]').forEach(select => {
          select.addEventListener('change', async () => {
            const fileId = select.dataset.fileVisibility;
            const previous = select.dataset.currentVisibility;
            const next = select.value;
            if (previous === next) return;
            select.disabled = true;
            try {
              await fetchJSON(`/files/me/${fileId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ visibility: next }),
              });
              select.dataset.currentVisibility = next;
              const row = select.closest('tr');
              const badge = row ? row.querySelector('.visibility-control .badge') : null;
              if (badge) {
                badge.className = `badge badge--${next}`;
                badge.textContent = visibilityText[next] || next;
              }
              const downloadLink = row ? row.querySelector('.file-actions a') : null;
              if (downloadLink) {
                downloadLink.textContent = next === 'disabled' ? '仅本人可下载' : '下载';
                downloadLink.title = next === 'disabled' ? '文件已禁用对外下载' : '打开新标签下载';
              }
              showToast('文件可见性已更新', 'success');
              if (previous === 'public' || next === 'public') {
                loadPublicFiles();
              }
            } catch (error) {
              select.value = previous;
              showToast(`更新失败：${error.message}`, 'error');
            } finally {
              select.disabled = false;
            }
          });
        });
        tbody.querySelectorAll('button[data-file]').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('确认删除该文件？')) return;
            try {
              await fetchJSON(`/files/me/${btn.dataset.file}`, { method: 'DELETE' });
              showToast('文件已删除', 'success');
              loadMyFiles();
              loadPublicFiles();
            } catch (error) {
              showToast(`删除失败：${error.message}`, 'error');
            }
          });
        });
      } catch (error) {
        console.error(error);
      }
    };


    const loadTokens = async () => {
      try {
        const data = await fetchJSON('/files/tokens');
        const records = Array.isArray(data) ? data : [];
        const tbody = document.querySelector('#token-table tbody');
        if (!tbody) return;
        if (!records.length) {
          tbody.innerHTML = '<tr><td class="table-empty" colspan="5">暂无令牌</td></tr>';
          return;
        }
        tbody.innerHTML = records.map(token => {
          const limit = [token.allowed_ips, token.allowed_cidrs].filter(Boolean).join(' / ') || '-';
          const stateLabel = token.is_active ? '启用' : '禁用';
          const stateClass = token.is_active ? 'status-pill status-pill--active' : 'status-pill status-pill--inactive';
          const actionIcon = token.is_active ? 'bx-hide' : 'bx-show';
          const actionLabel = token.is_active ? '禁用' : '启用';
          return `<tr>
            <td><code class="token-code">${escapeHTML(token.token)}</code></td>
            <td>${escapeHTML(token.name || '-')}</td>
            <td>${escapeHTML(limit)}</td>
            <td><span class="${stateClass}"><i class="bx ${token.is_active ? 'bx-check-circle' : 'bx-pause-circle'}"></i>${stateLabel}</span></td>
            <td><button class="text" data-token="${token.id}" data-active="${token.is_active ? '1' : '0'}"><i class="bx ${actionIcon}"></i>${actionLabel}</button></td>
          </tr>`;
        }).join('');
        tbody.querySelectorAll('button[data-token]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const formData = new FormData();
            formData.append('is_active', btn.dataset.active === '0');
            try {
              await fetchJSON(`/files/tokens/${btn.dataset.token}`, { method: 'PATCH', body: formData });
              loadTokens();
            } catch (error) {
              showToast(`操作失败：${error.message}`, 'error');
            }
          });
        });
      } catch (error) {
        console.error(error);
      }
    };

    document.getElementById('refresh-files').addEventListener('click', loadMyFiles);
    document.getElementById('file-scope').addEventListener('change', loadMyFiles);
    document.getElementById('refresh-tokens').addEventListener('click', loadTokens);
    const tokenForm = document.getElementById('token-create');
    tokenForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formEntries = new FormData(tokenForm);
      const payload = Object.fromEntries(formEntries.entries());
      const normalize = (value) => (typeof value === 'string' ? value.trim() : '');
      const customToken = normalize(payload.token);
      if (customToken) {
        payload.token = customToken;
      } else {
        delete payload.token;
      }
      const name = normalize(payload.name);
      payload.name = name || undefined;
      const ips = normalize(payload.allowed_ips);
      payload.allowed_ips = ips || undefined;
      const cidrs = normalize(payload.allowed_cidrs);
      payload.allowed_cidrs = cidrs || undefined;
      const hint = document.getElementById('token-hint');
      try {
        const result = await fetchJSON('/files/tokens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const tokenValue = result && result.token ? result.token : '';
        hint.textContent = tokenValue ? `令牌创建成功：${tokenValue}` : '令牌创建成功';
        hint.style.color = 'var(--color-primary)';
        showToast(tokenValue ? `令牌创建成功：${tokenValue}` : '令牌创建成功', 'success');
        tokenForm.reset();
        loadTokens();
      } catch (error) {
        hint.textContent = error.message;
        hint.style.color = '#b91c1c';
        showToast(`令牌创建失败：${error.message}`, 'error');
      }
    });

    loadMyFiles();
    loadTokens();
  }

  document.getElementById('refresh-public').addEventListener('click', loadPublicFiles);
  loadPublicFiles();
})();
</script>
{% endblock %}



