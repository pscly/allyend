{% extends "base.html" %}
{% block content %}
  {% set summary = link_summary %}
  <section class="page-header">
    <h2>
      {{ summary.name or "未命名链接" }}
      <span class="hint">{{ '（爬虫）' if summary.type == 'crawler' else '（API Key）' }}</span>
    </h2>
    <p>
      通过公开链接 <code>{{ slug }}</code> 分享运行状态。
      {% if summary.owner_name %}所属用户：{{ summary.owner_name }}。{% endif %}
      {% if summary.link_description %}备注：{{ summary.link_description }}{% endif %}
    </p>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>基础信息</h3>
      <div class="table-actions">
        <span class="hint">访问路径：<code>/pa/{{ slug }}</code></span>
      </div>
    </div>
    <div class="filters" style="margin-bottom:0;">
      <div>
        <label>类型</label>
        <div class="hint">{{ '爬虫' if summary.type == 'crawler' else 'API Key' }}</div>
      </div>
      <div>
        <label>内部 ID</label>
        <div class="hint">{{ summary.local_id or '-' }}</div>
      </div>
      <div>
        <label>最后活跃时间</label>
        <div class="hint">
          {% if summary.type == 'crawler' %}
            {{ summary.last_heartbeat or '未上报' }}
          {% else %}
            {{ summary.last_used_at or '未使用' }}
          {% endif %}
        </div>
      </div>
      <div>
        <label>来源 IP</label>
        <div class="hint">
          {% if summary.type == 'crawler' %}
            {{ summary.last_source_ip or '-' }}
          {% else %}
            {{ summary.last_used_ip or '-' }}
          {% endif %}
        </div>
      </div>
      <div>
        <label>创建时间</label>
        <div class="hint">{{ summary.link_created_at or '-' }}</div>
      </div>
      <div>
        <label>日志权限</label>
        <div class="hint">{{ '开放访问' if summary.allow_logs else '已关闭' }}</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h3>实时日志</h3>
      {% if summary.allow_logs %}
      <div class="table-actions">
        <button class="text" type="button" id="link-btn-reset">重置</button>
        <button type="button" id="link-btn-query">查询</button>
      </div>
      {% endif %}
    </div>
    {% if summary.allow_logs %}
    <div class="filters">
      <div>
        <label for="link-start">开始日期</label>
        <input type="date" id="link-start" />
      </div>
      <div>
        <label for="link-end">结束日期</label>
        <input type="date" id="link-end" />
      </div>
      <div>
        <label for="link-min-level">最小等级</label>
        <select id="link-min-level"></select>
      </div>
      <div>
        <label for="link-max-level">最大等级</label>
        <select id="link-max-level"></select>
      </div>
      <div>
        <label for="link-limit">最多条数</label>
        <input type="number" id="link-limit" min="1" max="1000" value="200" />
      </div>
      <div>
        <label for="link-device">设备名包含</label>
        <input type="text" id="link-device" placeholder="如：DESKTOP- 或 server-01" />
      </div>
      <div>
        <label for="link-ip">来源 IP 包含</label>
        <input type="text" id="link-ip" placeholder="如：10.0. 或 192.168." />
      </div>
      <div>
        <label for="link-query">关键字/正则</label>
        <input type="text" id="link-query" placeholder="例如：/招标计划/ 或 采集" />
        <label class="inline" style="margin-left:8px;">
          <input type="checkbox" id="link-regex-mode" /> 正则匹配
        </label>
      </div>
    </div>
    <div class="log-list" id="link-log-list"></div>
    <div class="empty-hint" id="link-log-empty" style="display:none;">暂无日志，可调整筛选后再次查询。</div>
    {% else %}
    <div class="empty-hint">该链接未开放日志访问。</div>
    {% endif %}
  </section>
{% endblock %}

{% block scripts %}
  {% if link_summary.allow_logs %}
  <script src="/static/public_link.js" defer></script>
  {% endif %}
{% endblock %}
